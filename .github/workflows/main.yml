name: Build

concurrency:
  group: "build"
  cancel-in-progress: true

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '*.md'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          path: "src"

      - name: Checkout builds branch
        uses: actions/checkout@v4
        continue-on-error: true # Melanjutkan jika branch builds belum ada
        with:
          ref: "builds"
          path: "builds"

      - name: Create builds folder if not exists
        run: mkdir -p builds

      - name: Clean old builds
        run: |
          rm -f builds/*.cs3
          rm -f builds/*.jar
          rm -f builds/plugins.json

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin' # Distribusi stabil yang direkomendasikan
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Access Secrets
        run: |
          cd src
          # Menggunakan blok heredoc (EOF) agar penulisan file local.properties lebih bersih
          cat <<EOF > local.properties
          TMDB_API=${{ secrets.TMDB_API }}
          DUMP_API=${{ secrets.DUMP_API }}
          DUMP_KEY=${{ secrets.DUMP_KEY }}
          ANICHI_API=${{ secrets.ANICHI_API }}
          ANICHI_SERVER=${{ secrets.ANICHI_SERVER }}
          ANICHI_ENDPOINT=${{ secrets.ANICHI_ENDPOINT }}
          ANICHI_APP=${{ secrets.ANICHI_APP }}
          ZSHOW_API=${{ secrets.ZSHOW_API }}
          SFMOVIES_API=${{ secrets.SFMOVIES_API }}
          CINEMATV_API=${{ secrets.CINEMATV_API }}
          GHOSTX_API=${{ secrets.GHOSTX_API }}
          SUPERSTREAM_FIRST_API=${{ secrets.SUPERSTREAM_FIRST_API }}
          SUPERSTREAM_SECOND_API=${{ secrets.SUPERSTREAM_SECOND_API }}
          SUPERSTREAM_THIRD_API=${{ secrets.SUPERSTREAM_THIRD_API }}
          SUPERSTREAM_FOURTH_API=${{ secrets.SUPERSTREAM_FOURTH_API }}
          AsianDrama_API=${{ secrets.AsianDrama_API }}
          FanCode_API=${{ secrets.FanCode_API }}
          Whvx_API=${{ secrets.Whvx_API }}
          Su_sports=${{ secrets.Su_sports }}
          PirateIPTV=${{ secrets.PirateIPTV }}
          SonyIPTV=${{ secrets.SonyIPTV }}
          JapanIPTV=${{ secrets.JapanIPTV }}
          CatflixAPI=${{ secrets.CatflixAPI }}
          ConsumetAPI=${{ secrets.ConsumetAPI }}
          FlixHQAPI=${{ secrets.FlixHQAPI }}
          WhvxAPI=${{ secrets.WhvxAPI }}
          WhvxT=${{ secrets.WhvxT }}
          SharmaflixApi=${{ secrets.SharmaflixApi }}
          SharmaflixApikey=${{ secrets.SharmaflixApikey }}
          HianimeAPI=${{ secrets.HianimeAPI }}
          Vidsrccc=${{ secrets.Vidsrccc }}
          WASMAPI=${{ secrets.WASMAPI }}
          KissKh=${{ secrets.KissKh }}
          KisskhSub=${{ secrets.KisskhSub }}
          StreamPlayAPI=${{ secrets.StreamPlayAPI }}
          PROXYAPI=${{ secrets.PROXYAPI }}
          KAISVA=${{ secrets.KAISVA }}
          MAL_API=${{ secrets.MAL_API }}
          MOVIEBOX_SECRET_KEY_DEFAULT=${{ secrets.MOVIEBOX_SECRET_KEY_DEFAULT }}
          MOVIEBOX_SECRET_KEY_ALT=${{ secrets.MOVIEBOX_SECRET_KEY_ALT }}
          SuperToken=${{ secrets.SuperToken }}
          KAIDEC=${{ secrets.KAIDEC }}
          KAIENC=${{ secrets.KAIENC }}
          KAIMEG=${{ secrets.KAIMEG }}
          NuvioStreams=${{ secrets.NuvioStreams }}
          YFXDEC=${{ secrets.YFXDEC }}
          YFXENC=${{ secrets.YFXENC }}
          VideasyDEC=${{ secrets.VideasyDEC }}
          EOF

      - name: Build Plugins
        run: |
          cd src
          chmod +x gradlew
          # Menambahkan clean dan refresh-dependencies untuk mengatasi error 'Could not find' dari JitPack
          ./gradlew clean make makePluginsJson --refresh-dependencies --no-build-cache
          
          # Menggunakan find untuk memastikan semua file .cs3 dan .jar tersalin meskipun di subfolder
          mkdir -p ../builds
          find . -name "*.cs3" -exec cp {} ../builds/ \;
          find . -name "*.jar" -exec cp {} ../builds/ \; || true
          [ -f build/plugins.json ] && cp build/plugins.json ../builds/ || true

      - name: Push builds
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd builds
          # Melakukan inisialisasi ulang git agar proses push ke branch builds selalu berhasil
          git init
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git checkout -b builds
          git add .
          git commit -m "Build $GITHUB_SHA" || exit 0
          git push origin builds --force
          
